<section class="product">
  <div class="product__carousel carousel_product reveal desktop" role="region" aria-label="Product gallery" aria-expanded="false">
    {% for image in product.images %}
      <div class="product__carousel-item" id="img-{{ forloop.index0 }}">
        {% render "media-img", media: image %}
      </div>
    {% endfor %}
  </div>

  <div class="product__carousel-dots desktop">
    {% for image in product.images %}
      <button class="product__dot{% if forloop.first %} is-active{% endif %}" data-index="{{ forloop.index0 }}" aria-label="Go to image {{ forloop.index }}"></button>
    {% endfor %}
  </div>

  <div class="product__carousel swiper-container carousel_product carousel_product_mobile reveal mobile">
    <div class="swiper-wrapper">
      {%- for image in product.images -%}
        <div class="swiper-slide">
          {%- assign img = image -%}
          {%- render "media-img", media: img -%}
        </div>
      {%- endfor -%}
    </div>

    <div class="swiper-button-prev swiper-product-button-prev">
      {% render 'icon-arrow-left' %}
    </div>
    <div class="swiper-button-next swiper-product-button-next">
      {% render 'icon-arrow-right' %}
    </div>
  </div>

  <div class="product__meta">
    <div class="product__content">
      <div class="product__info">
        <h2 class="product__title reveal">{{- product.title -}}</h2>

        <div id="price-{{ section.id }}" class="product__price no-js-hidden reveal">
          <p id="product__price-sale" class="caption" style="text-decoration: line-through; {% unless product.selected_or_first_available_variant.compare_at_price > product.selected_or_first_available_variant.price %}display: none;{% endunless %}">
            {{ product.selected_or_first_available_variant.compare_at_price | money }}
          </p>

          <p id="product__price-og">{{ product.selected_or_first_available_variant.price | money }}</p>
        </div>
      </div>
      {% if product.metafields.custom.small_description != blank %}
        <p class="product__description reveal text-fade">{{ product.metafields.custom.small_description }}</p>
      {% endif %}
    </div>

    <form id="product-form" class="product__form" action="/cart/add" method="post">
      <input type="hidden" name="id" id="product-select" value="{{ product.selected_or_first_available_variant.id }}">
      {% if product.metafields.my_fields.colour_name != blank %}
        <input type="text" name="properties[colour]" style="display: none;" value="{{ product.metafields.my_fields.colour_name }}">
      {% endif %}

      <div class="product__variants reveal">
        {% if product.variants.size > 1 %}
          {%- for option in product.options_with_values -%}
            <div class="product__variant">
              {% if option.name == 'Color' or option.name == 'Colour' %}

                <p class="product__variant-title">
                  {{ option.name }}:
                  <span id="active-color-label">
                    {{ product.selected_or_first_available_variant.option1 }}
                  </span>
                </p>

              {% else %}

                <p class="product__variant-title">
                  {{ option.name }}:
                </p>

              {% endif %}

              <div class="product__variant-pills" data-option-position="{{ option.position }}">

                {% if option.name == 'Color' or option.name == 'Colour' %}

                  {% for value in option.values %}
                    {% assign handle = value | handleize %}
                    <button type="button" class="variant-swatch{% if forloop.first %} active{% endif %}" data-value="{{ value | escape }}" onclick="changeSelect(this)" aria-label="{{ value }}" style="background-color: var(--{{ handle }});"></button>
                  {% endfor %}

                {% else %}

                  {% for value in option.values %}
                    <button type="button" class="variant-pill caption{% if forloop.first %} active{% endif %}" data-value="{{ value | escape }}" onclick="changeSelect(this)">
                      {{ value }}
                    </button>
                  {% endfor %}

                {% endif %}

              </div>
            </div>
          {%- endfor -%}

        {% endif %}
      </div>

      {% for block in section.blocks %}
        {% case block.type %}
          {% when '@app' %}
            {% render block %}
        {% endcase %}
      {% endfor %}

      <div class="product__atc reveal">
        <div class="product__quantity button_pill">
          <button id="product-btn-minus" class="product__btn-minus no-js-hidden" name="minus" type="button" aria-label="Decrease Quantity" onclick="changeQuantity('#form-quantity', '-')">
            {% render 'icon-minus' %}
          </button>
          <input class="caption" min="1" type="number" id="form-quantity" name="quantity" value="1" class="">
          <button id="product-btn-plus" class="product__btn-plus no-js-hidden" name="plus" type="button" aria-label="Increase Quantity" onclick="changeQuantity('#form-quantity', '+')">
            {% render 'icon-plus' %}
          </button>
        </div>

        <div id="product-btn" class="product__buttons {% if product.selected_or_first_available_variant.available %}available{% endif %}">
          <button id="product-btn-avail" type="submit" name="add" class="button button--primary button--full-width" aria-label="Add to Cart">
            Add to Cart
          </button>

          <div id="product-btn-sold" class="product__atc-button product__atc-btn--disabled button button--primary button--full-width">Sold Out</div>
        </div>

        <div class="product__errors" data-ajax-cart-messages="form"></div>
      </div>
    </form>

    {% if product.metafields.custom.detail_modals != blank %}
      <div class="product__modals">
        <ul class="product__modals-list">
          {% for modal in product.metafields.custom.detail_modals.value %}
            <li>
              <button class="product__modal-trigger text-fade text-base" data-modal-target="modal-{{ forloop.index }}">
                {{ modal.title }}
              </button>
            </li>
          {% endfor %}
        </ul>
      </div>
    {% endif %}
  </div>

  {% if product.metafields.custom.detail_modals != blank %}
    {% for modal in product.metafields.custom.detail_modals.value %}
      <div id="modal-{{ forloop.index }}" class="product__modal" aria-hidden="true">
        <div class="product__modal-overlay" data-close-modal></div>
        <div class="product__modal-content">
          <div class="product__modal-header">
            <h2 class="caption">{{ modal.title }}</h2>
            <button class="product__modal-close button--link" data-close-modal>{% render 'icon-cross' %}</button>
          </div>
          <div class="product__modal-body rte">
            {{ modal.content | metafield_tag }}
          </div>
        </div>
      </div>
    {% endfor %}
  {% endif %}

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const modalTriggers = document.querySelectorAll('.product__modal-trigger');
      const modals = document.querySelectorAll('.product__modal');
      const closeButtons = document.querySelectorAll('[data-close-modal]');

      modalTriggers.forEach(btn => {
        btn.addEventListener('click', () => {
          const target = document.getElementById(btn.dataset.modalTarget);
          if (target) {
            target.classList.add('is-open');
          }

          document.body.classList.add('modal-open');
        });
      });

      closeButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          modals.forEach(m => m.classList.remove('is-open'));
          document.body.classList.remove('modal-open');
        });
      });
    });

    function changeSelect(clickedBtn) {

// Remove 'active' from siblings and add to clicked
      const parentGroup = clickedBtn.closest('.product__variant-pills');
      parentGroup.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
      clickedBtn.classList.add('active');

// Update visible color label
      const activeColorLabel = document.getElementById('active-color-label');

      if (activeColorLabel) {
        const isColorGroup = parentGroup.previousElementSibling ?. textContent.toLowerCase().includes('color');

        if (isColorGroup) {
          activeColorLabel.textContent = clickedBtn.dataset.value;
        }
      }

// Get current selected values from all option groups
      const option1 = document.querySelector('[data-option-position="1"] .active') ?. dataset.value || '';
      const option2 = document.querySelector('[data-option-position="2"] .active') ?. dataset.value || '';
      const option3 = document.querySelector('[data-option-position="3"] .active') ?. dataset.value || '';

      let id = '';
      let price = '';
      let salePrice = '';
      let sale = false;
      let avail = false;{% for v in product.variants %}if (
          option1 === "{{ v.option1 }}"{% if product.options[1] %} && option2 === "{{ v.option2 }}"{% endif %}{% if product.options[2] %} && option3 === "{{ v.option3 }}"{% endif %}
        ) {
          id = {{ v.id }};
          price = "{{ v.price | money }}";
          salePrice = "{{ v.compare_at_price | money }}";{% if v.compare_at_price > v.price %}sale = true;{% endif %}avail = {{ v.available }};
        }
      {% endfor %}

      const cartBtn = document.querySelector("#product-btn");
      const priceSale = document.querySelector("#product__price-sale");
      const priceOg = document.querySelector("#product__price-og");

      if (id !== '') {
        document.getElementById("product-select").value = id;
        updateQueryString('variant', id);
      }

      if (avail) {
        cartBtn.classList.add("available");
      } else {
        cartBtn.classList.remove("available");
      }

      if (sale) {
        priceSale.style.display = "block";
        priceSale.innerHTML = salePrice;
      } else {
        priceSale.style.display = "none";
      } priceOg.innerHTML = price;
    }

    document.addEventListener('DOMContentLoaded', () => {
      const carousel = document.querySelector('.carousel_product.desktop');
      const dots = document.querySelectorAll('.product__dot');
      const items = document.querySelectorAll('.product__carousel-item');

      if (! carousel || ! dots.length) {
        return;
      }

// Click → scroll
      dots.forEach(dot => {
        dot.addEventListener('click', () => {
          const index = dot.dataset.index;
          const target = document.getElementById(`img-${index}`);
          if (! target) {
            return;
          }

          target.scrollIntoView({behavior: 'smooth', block: 'start'});
        });
      });

// Scroll → update active dot
      const observer = new IntersectionObserver(entries => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            const index = entry.target.id.replace('img-', '');

            dots.forEach(dot => dot.classList.remove('is-active'));
            const activeDot = document.querySelector(`.product__dot[data-index="${index}"]`);
            if (activeDot) {
              activeDot.classList.add('is-active');
            }
          }
        });
      }, {
        root: null,
        threshold: 0.6
      });

      items.forEach(item => observer.observe(item));
    });
  </script>
</section>

{% schema %}
  {
    "name": "Main Product",
    "enabled_on": {
      "templates": ["product"]
    },
    "class": "product-container",
    "limit": 1,
    "settings": [],
    "blocks": [
      {
        "type": "@app"
      }
    ]
  }
{% endschema %}